---
title: "RCC SM Analysis"
author: "Andy Cox"
date: "24/02/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

## Analyses of RCC Social Media Data

```{r}
#Clear workspace, set working directory and load packages
rm(list=ls())
options(stringsAsFactors = FALSE)

setwd("/Users/AndyC/Dropbox/rdata/RCCsocmed/RCC_SM_analysis_24022017")
```

First objective is to do some preliminary cleaning of the posts and save as RDS 

```{r}
# read in data removiong multibyte strings
dat1<-read.csv("alldatafinal23022017v2.csv",header=TRUE,stringsAsFactors=FALSE,sep=",",
               fileEncoding="latin1")
#Intial cleaning of the body text
  #remove excess whitespace
dat1$body_text<-gsub("\\s+"," ",dat1$body_text)
  #Remove backslashes
dat1$body_text<-gsub("\"", "'",dat1$body_text)

#same for same for post_titles
#remove excess whitespace
dat1$bpost_titles<-gsub("\\s+"," ",dat1$post_titles)
#Remove backslashes
dat1$post_titles<-gsub("\"", "'",dat1$post_titles)
dat1$post_titles<-gsub("RE:","",dat1$post_titles)
dat1$post_titles<-tolower(dat1$post_titles)

saveRDS(dat1,"cleaned_all_data_24022017")
```

First produce some rpeliminary desriptives. The total numebr of users is `r length(unique(dat1$username))`. The total number of posts available is `r nrow(dat1)`  and the total numebr of posts per site is as follows:

```{r}
dat1<-readRDS("cleaned_all_data_24022017")
dat1$post_date<-as.Date(dat1$post_date)
dat1$days_age<-as.numeric(dat1$post_date-as.Date("2017-02-24"))

table(dat1$site)
```
The total number of posts over time  adn by site is shown in figure 1a and b  below:

```{r}
year1<-as.numeric(format(dat1$post_date,"%Y"))
yearsums<-table(year1)[-length(table(year1))]
plot(as.numeric(names(yearsums)),as.numeric(unname(yearsums)),type="line",col="red",xlab="Year",ylab="Numer of Posts")

temp1<-data.frame(years=year1,site=dat1$site)
temp1<-table(temp1$years,temp1$site)
temp1<-temp1[-nrow(temp1),]

plot(as.numeric(rownames(temp1)),as.numeric(unname(temp1[,2])),type="line",col="red",xlab="Year",ylab="Numer of Posts")
lines(as.numeric(rownames(temp1)),as.numeric(unname(temp1[,1])),col="blue")
lines(as.numeric(rownames(temp1)),as.numeric(unname(temp1[,3])),col="green")
lines(as.numeric(rownames(temp1)),as.numeric(unname(temp1[,4])),col="black")
legend(2000,10000,lty=c(1,1,1,1), c("CancerNetwork","Cancer Compass","Daily Strength","MacMillan"),
lwd=c(2.5,2.5,2.5,2.5),col=c("red","blue","green","black"))
```

```{r}
bios<-readRDS("/Users/AndyC/Dropbox/rdata/RCCsocmed/daily_strength_Kidney_Cancer_user_bios_230117")

bios$age<-gsub(" Age: ","",bios$age)
bios$age<-gsub("Private","0",bios$age)
#remove excess whitespace
bios$age<-as.numeric(gsub("\\s+"," ",bios$age))
age<-bios$age[bios$age>0]
mn_age<-mean(age)
ci<-quantile(age,c(0.075,0.975))
age_n<-length(age)
bios$gender<-gsub("Gender: ","",bios$gender)
#remove excess whitespace
bios$gender<-gsub("\\s+"," ",bios$gender)
gender<-bios$gender[bios$gender!="Private"]
p_female<-round(length(gender[gender=="Female "])/length(gender)*100,1)
gender_n<-length(gender)
```
Using only the data from Daily Strength, posters had a mean age of `r paste0(round(mn_age,1)," (95 percentiles ",round(unname(ci[1]),1),"~",round(unname(ci[2]),1),": n= ",age_n,")")` and most posters were female `r paste0(p_female,"% (n= ",gender_n,")")`.

##Description of Post Title N-Grams
In these analyses stopwords are removed and repeats of post titles are retained
```{r}
#tidy workspace
rm("bios","yearsums","age","age_n","site","temp1","year1","ci","gender","mn_age","gender_n","p_female","p_male","datDStr")

library(quanteda)
library(ggplot2)

ttls1<-dat1$post_titles

myCorpus0 <- corpus(ttls1) 
myCorpus0<-toLower(myCorpus0, keepAcronyms = TRUE)


######
ngrams <-dfm(myCorpus0, ngrams = 1, verbose = TRUE, toLower = TRUE,
  removeNumbers = TRUE, removePunct = TRUE, removeSeparators = TRUE,
  removeTwitter = TRUE, stem = FALSE,ignoredFeatures=stopwords("english"))

allwds_freq<-sort(colSums(ngrams),decreasing=T)

wds1<-data.frame(cbind(names(allwds_freq),allwds_freq),stringsAsFactors =FALSE)
rownames(wds1)<-NULL
colnames(wds1)<-c("word","freq")
wds1$freq<-as.numeric(wds1$freq)
# 
 
ggplot(wds1[1:30,], aes(reorder(word, freq),freq)) +
  geom_bar(stat = "identity") + coord_flip() +
  xlab("Words") + ylab("Frequency") +
  ggtitle("Most frequent Words")

saveRDS(wds1,"n_grams1_titles24022017")

######
ngrams <-dfm(myCorpus0, ngrams = 2, verbose = TRUE, toLower = TRUE,
  removeNumbers = TRUE, removePunct = TRUE, removeSeparators = TRUE,
  removeTwitter = TRUE, stem = FALSE,ignoredFeatures=stopwords("english"))

allwds_freq<-sort(colSums(ngrams),decreasing=T)

wds2<-data.frame(cbind(names(allwds_freq),allwds_freq),stringsAsFactors =FALSE)
rownames(wds2)<-NULL
colnames(wds2)<-c("word","freq")
wds2$freq<-as.numeric(wds2$freq)
saveRDS(wds2,"n_grams2_titles24022017")
ggplot(wds2[1:30,], aes(reorder(word, freq),freq)) +
  geom_bar(stat = "identity") + coord_flip() +
  xlab("Words") + ylab("Frequency") +
  ggtitle("Most frequent 2-Grams")
######
ngrams <-dfm(myCorpus0, ngrams = 3, verbose = TRUE, toLower = TRUE,
  removeNumbers = TRUE, removePunct = TRUE, removeSeparators = TRUE,
  removeTwitter = TRUE, stem = FALSE,ignoredFeatures=stopwords("english"))

allwds_freq<-sort(colSums(ngrams),decreasing=T)

wds3<-data.frame(cbind(names(allwds_freq),allwds_freq),stringsAsFactors =FALSE)
rownames(wds3)<-NULL
colnames(wds3)<-c("word","freq")
wds3$freq<-as.numeric(wds3$freq)
saveRDS(wds3,"n_grams3_titles24022017")
ggplot(wds3[1:30,], aes(reorder(word, freq),freq)) +
  geom_bar(stat = "identity") + coord_flip() +
  xlab("Words") + ylab("Frequency") +
  ggtitle("Most frequent 3-Grams")
######
ngrams <-dfm(myCorpus0, ngrams = 4, verbose = TRUE, toLower = TRUE,
  removeNumbers = TRUE, removePunct = TRUE, removeSeparators = TRUE,
  removeTwitter = TRUE, stem = FALSE,ignoredFeatures=stopwords("english"))

allwds_freq<-sort(colSums(ngrams),decreasing=T)

wds4<-data.frame(cbind(names(allwds_freq),allwds_freq),stringsAsFactors =FALSE)
rownames(wds4)<-NULL
colnames(wds4)<-c("word","freq")
wds4$freq<-as.numeric(wds4$freq)
saveRDS(wds4,"n_grams2_titles24022017")


#Analyses of the titles
x<-sort(table(dat1$post_titles),decreasing=T)
y<-data.frame(topics=names(x),freq=unname(x))[,-2]
```
